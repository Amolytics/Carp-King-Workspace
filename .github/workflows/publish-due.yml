name: Publish scheduled slots

on:
  schedule:
    - cron: '*/1 * * * *' # every minute
  workflow_dispatch: {}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Call publish-due endpoint
        run: |
          set -e
          if [ -z "${{ secrets.BACKEND_URL }}" ] || [ -z "${{ secrets.ADMIN_BACKUP_TOKEN }}" ]; then
            echo "Missing BACKEND_URL or ADMIN_BACKUP_TOKEN secrets"; exit 1
          fi
          echo "Calling publish job on ${{ secrets.BACKEND_URL }}"
          curl -s -X POST "${{ secrets.BACKEND_URL }}/api/admin/publish-due" \
            -H "x-admin-token: ${{ secrets.ADMIN_BACKUP_TOKEN }}" \
            -H "Accept: application/json" -o /tmp/publish_out.json || true
          echo "Response:"; cat /tmp/publish_out.json || true
