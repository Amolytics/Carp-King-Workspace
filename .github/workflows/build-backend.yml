name: Build and publish backend image

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ secrets.REGISTRY_USERNAME || github.actor }}
          password: ${{ secrets.REGISTRY_PAT || secrets.Amolytics }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          file: backend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/carp-king-backend:latest

      - name: Deploy to remote server (optional)
        if: ${{ secrets.DEPLOY_HOST != '' }}
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_PRIVATE_KEY }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          script: |
            set -euo pipefail
            echo "Logging into registry if credentials provided..."
            if [ -n "${{ secrets.DEPLOY_REGISTRY_PAT }}" ]; then
              echo "${{ secrets.DEPLOY_REGISTRY_PAT }}" | docker login ghcr.io -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin
            fi
            # Pull both backend and frontend images so they are available locally
            echo "Pulling latest images..."
            docker pull ghcr.io/${{ github.repository_owner }}/carp-king-backend:latest || true
            docker pull ghcr.io/${{ github.repository_owner }}/carp-king-frontend:latest || true
            # Change to deploy path if provided
            DEPLOY_PATH="${{ secrets.DEPLOY_COMPOSE_PATH }}"
            if [ -n "$DEPLOY_PATH" ]; then
              cd "$DEPLOY_PATH"
            else
              cd /srv/carp-king || true
            fi
            # Backup SQLite DB if present
            DB_PATH="./data/carp-king.sqlite"
            if [ -f "$DB_PATH" ]; then
              TIMESTAMP=$(date -u +"%Y%m%dT%H%M%SZ")
              BACKUP_DIR=./backups
              mkdir -p "$BACKUP_DIR"
              cp "$DB_PATH" "$BACKUP_DIR/carp-king-backup-$TIMESTAMP.sqlite" || true
              echo "DB backed up to $BACKUP_DIR/carp-king-backup-$TIMESTAMP.sqlite"
            else
              echo "No DB file at $DB_PATH, skipping backup"
            fi
            # Pull and restart compose stack (no build)
            docker compose pull || true
            docker compose up -d --no-build
            docker image prune -f || true
